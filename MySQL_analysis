/*1.In each decade, how many schools were there that produced players?*/

SELECT  
  FLOOR(yearID/10)*10 AS decades  
  ,COUNT(DISTINCT schoolID) AS No_of_schools
FROM schools
GROUP BY decades
ORDER BY decades;

/*2. What are the names of the top 5 schools that produced the most players? */

SELECT  
  sd.name_full 
  ,COUNT(DISTINCT s.playerID) as No_of_players
FROM schools s LEFT JOIN school_details sd 
ON s.schoolID = sd.schoolID 
GROUP BY sd.name_full 
ORDER BY No_of_players DESC 
LIMIT 5;

--RESULT: 
University of Texas at Austin	107
University of Southern California	105
Arizona State University	101
Stanford University	86
University of Michigan	76 --

/*3.For each decade, what were the names of the top 3 schools that produced the most players? */

WITH ds AS 
  (SELECT s.schoolID
    ,FLOOR(yearID/10)*10 AS decades 
    ,count(distinct s.playerID) as No_of_players
  FROM schools s LEFT JOIN school_details sd 
  ON s.schoolID = sd.schoolID 
  GROUP BY s.schoolID, decades
  ),
rk AS ( 
  SELECT *, 
    ROW_NUMBER () over (partition by decades order by no_of_players DESC) as ranking
  FROM ds
  )
SELECT
  sd.name_fulL 
  ,r.decades
  ,r.no_of_players
  ,r.ranking 
FROM rk r LEFT JOIN school_details sd 
ON r.schoolID = sd.schoolID 
WHERE ranking <= 3
ORDER BY r.decades, r.ranking

/*4. Return the top 20% of teams in terms of average annual spending. */

WITH total_spend AS (
SELECT 
  teamID
  ,yearID
  ,SUM(salary) AS total_spend_per_year
FROM salaries s 
GROUP BY teamID, yearID
), 		
percentile AS (
SELECT 
  teamID
  ,AVG(total_spend_per_year) AS avg_spend
	,NTILE(5) OVER (ORDER BY AVG(total_spend_per_year) DESC) AS spend_percentile
FROM total_spend
GROUP BY teamID
)
SELECT teamId
      ,ROUND((avg_spend/1000000),1) AS avg_spend_milions 
FROM percentile
WHERE spend_percentile = 1 
ORDER BY avg_spend DESC

--RESULT: 
teamID |  avg_spend_milions
SFG    |  143.5
LAA    |  118.5
NYA    |  109.4
BOS    |  81.1
LAN    |  74.6
WAS    |  71.5
ARI    |  71.2
PHI    |  66.1 -- 

/*5. For each team, show the cumulative sum of spending over the years. */

WITH total_spend AS (
          SELECT teamID
                ,yearID
                ,SUM(salary) AS total_spend_per_year
					FROM salaries s 
					GROUP BY teamID, yearID)
  SELECT teamID
        ,yearID 
			  ,ROUND((SUM(total_spend_per_year) OVER (PARTITION BY teamID ORDER BY yearID ASC)/1000000),2) AS cumulative_spend
	FROM total_spend

/* 6. Return the first year that each team's cumulative spending surpassed 1 billion. */ 
WITH total_spend AS (
        SELECT teamID
              ,yearID
              ,SUM(salary) AS total_spend_per_year
				FROM salaries s 
				GROUP BY teamID, yearID),
ts AS (
        SELECT teamID
              ,yearID 
			        ,ROUND((SUM(total_spend_per_year) OVER (PARTITION BY teamID ORDER BY yearID ASC)/1000000000),2) AS cum_spend_bilions
			  FROM total_spend
        ),
ts_bilion AS (
      SELECT * FROM ts WHERE cum_spend_bilions >= 1),
ranking AS (
        SELECT *,
				      RANK() OVER (PARTITION BY teamId ORDER BY yearId ASC) AS ranking
			  FROM ts_bilion)
SELECT teamID
      ,yearID
      ,cum_spend_bilions
FROM ranking 
WHERE ranking =1
